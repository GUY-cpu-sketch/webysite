<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Render Chat App</title>
<style>
  body {
    background-color: #808080; /* gray */
    font-family: Arial, sans-serif;
    color: white;
    margin: 0;
    padding: 0;
  }
  #auth, #chat {
    padding: 10px;
  }
  input, button {
    margin: 5px 0;
    padding: 6px;
    font-size: 14px;
  }
  #messages div, #whispers div {
    padding: 4px 6px;
    margin: 2px 0;
    border-radius: 4px;
  }
  .normal {
    background-color: #ffffff;
    color: black;
  }
  .whisper {
    background-color: #ffff66;
    color: black;
  }
  .admin {
    font-weight: bold;
    color: #ff9900; /* orange for admin names */
  }
  .muted {
    opacity: 0.5;
    font-style: italic;
  }
  #admin-panel {
    background: #333;
    color: white;
    padding: 5px;
    overflow-y: auto;
  }
  #admin-panel h4 {
    margin: 2px 0;
    font-size: 14px;
  }
  #chat-wrapper {
    display: flex;
    gap: 10px;
  }
  #messages {
    flex: 3;
    max-height: 400px;
    overflow-y: auto;
  }
  #admin-panel {
    flex: 1;
    max-height: 400px;
  }
  #input {
    width: 100%;
    margin-top: 5px;
  }
</style>
</head>
<body>

<div id="auth">
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button id="register">Register</button>
  <button id="login">Login</button>
</div>

<div id="chat" style="display:none;">
  <div id="chat-wrapper">
    <div id="messages"></div>
    <div id="admin-panel">
      <h4>Admin Panel (DEV only)</h4>
      <div id="online-users"></div>
      <div id="whispers"></div>
    </div>
  </div>
  <input id="input" placeholder="Message..." />
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let username;
const adminName = "DEV";

const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const input = document.getElementById("input");
const messagesDiv = document.getElementById("messages");
const onlineDiv = document.getElementById("online-users");
const whispersDiv = document.getElementById("whispers");

// --- Auth ---
document.getElementById("register").onclick = async () => {
  const res = await fetch("/register", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username: usernameInput.value, password: passwordInput.value })
  });
  const data = await res.json();
  alert(data.success ? "Registered!" : data.msg);
};

document.getElementById("login").onclick = async () => {
  const res = await fetch("/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username: usernameInput.value, password: passwordInput.value })
  });
  const data = await res.json();
  if (!data.success) return alert(data.msg);
  username = usernameInput.value;
  authDiv.style.display = "none";
  chatDiv.style.display = "block";
  socket.emit("registerSocket", { username });
};

// --- Socket.IO ---
socket.on("chat-history", messages => messages.forEach(m => appendMessage(m.user, m.message)));
socket.on("chat", data => appendMessage(data.user, data.message));

socket.on("whisper", data => {
  appendMessage(data.from, `[Whisper] -> ${data.to}: ${data.message}`, true);
  if(username === adminName) {
    const div = document.createElement("div");
    div.textContent = `[Whisper] ${data.from} -> ${data.to}: ${data.message}`;
    div.className = "whisper";
    whispersDiv.appendChild(div);
  }
});

socket.on("online-users", users => {
  onlineDiv.innerHTML = "<b>Online:</b> " + users.map(u => u === adminName ? `<span class="admin">${u}</span>` : u).join(", ");
});

socket.on("ban-cookie", data => {
  if (username === data.user) {
    document.cookie = `banned=${data.cookie}; path=/; max-age=${10*365*24*60*60}`;
    alert("You have been banned!");
    location.reload();
  }
});

// --- Message Input ---
input.addEventListener("keypress", e => {
  if (e.key === "Enter" && input.value.trim()) {
    socket.emit("chat", { user: username, message: input.value.trim() });
    input.value = "";
  }
});

// --- Helpers ---
function appendMessage(user, msg, isWhisper=false) {
  const div = document.createElement("div");
  let classes = isWhisper ? "whisper" : "normal";
  if(user === adminName) classes += " admin";
  div.className = classes;
  div.textContent = user === adminName ? `[ADMIN] ${user}: ${msg}` : `${user}: ${msg}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
</body>
</html>
